[tox]
envlist = py312, lint, coverage, security, kerykeion-tests, performance
isolated_build = true

[testenv]
deps = -r requirements.txt
commands = pytest {posargs}

# Kerykeion-specific tests
[testenv:kerykeion-tests]
deps = 
    -r requirements.txt
    pytest-asyncio
    pytest-mock
commands = 
    pytest -m "kerykeion and not slow" --cov=app/services {posargs}

# Performance and load tests
[testenv:performance]
deps = 
    -r requirements.txt
    pytest-asyncio
    pytest-benchmark
    psutil
commands = 
    pytest -m performance --benchmark-disable {posargs}

# Unit tests only (fast)
[testenv:unit]
deps = 
    -r requirements.txt
    pytest-mock
commands = 
    pytest -m "unit and not slow" {posargs}

# Integration tests only
[testenv:integration] 
deps = 
    -r requirements.txt
    pytest-asyncio
commands = 
    pytest -m "integration and not slow" {posargs}

# Accuracy tests with known data
[testenv:accuracy]
deps = 
    -r requirements.txt
    pytest-asyncio
commands = 
    pytest -m "accuracy" {posargs}

# Russian localization tests
[testenv:localization]
deps = -r requirements.txt
commands = 
    pytest -m localization {posargs}

[testenv:lint]
deps = 
    black
    isort
    flake8
    mypy
commands =
    black --check app/ tests/
    isort --check-only app/ tests/
    flake8 app/ tests/
    mypy app/

[testenv:coverage]
deps = 
    pytest
    pytest-cov
commands = pytest --cov=app --cov-report=html --cov-report=term

[testenv:security]
deps =
    bandit
    safety
commands =
    bandit -r app/
    safety check

[flake8]
max-line-length = 88
extend-ignore = E203, W503
per-file-ignores =
    __init__.py:F401
exclude = 
    .git,
    __pycache__,
    .tox,
    .coverage,
    htmlcov,
    *.egg-info

[coverage:run]
source = app
omit = 
    */tests/*
    */test_*
    */__init__.py

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError